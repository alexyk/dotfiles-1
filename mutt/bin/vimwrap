#!/usr/bin/env rvm 2.1.0@skanev do ruby
require 'mail'
require 'rdiscount'

def add_html_version(filename)
  mail = Mail.read(filename)
  original = mail.body.to_s
  without_signature = original.sub(/--\nStefan Kanev.*?\Z/m, '')
  html_version = RDiscount.new(without_signature).to_html

  mail.header['Markdown'] = nil
  mail.header['Date'] = nil
  mail.body = nil
  mail.text_part = Mail::Part.new do
    content_type 'text/plain; charset=UTF-8'
    body original
  end

  mail.html_part = Mail::Part.new do
    content_type 'text/html; charset=UTF-8'
    body html_version
  end

  puts mail.to_s
  #File.write filename, mail.to_s
end

filename = ARGV[0]

#system('vim', filename) || exit(1)

contents = File.read(filename)

add_html_version(filename) if contents =~ /^Markdown: true$/

